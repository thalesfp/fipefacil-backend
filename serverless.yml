service: fipefacil

custom:
  functions:
    reservedConcurrency: 2
    batchSize: 1
    timeout: 15
  enterprise:
    collectLambdaLogs: false
  webpack:
    includeModules:
      forceExclude:
        - aws-sdk
  customDomain:
    domainName: ${self:service}.thales.work
    certificateName: "*.thales.work"

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, "dev"}
  region: us-east-1
  accountId: 678634121400
  memorySize: 256
  environment:
    PRICES_TABLE: prices
    REFERENCES_QUEUE: https://sqs.${self:provider.region}.amazonaws.com/${self:provider.accountId}/references
    BRANDS_QUEUE: https://sqs.${self:provider.region}.amazonaws.com/${self:provider.accountId}/brands
    MODELS_QUEUE: https://sqs.${self:provider.region}.amazonaws.com/${self:provider.accountId}/models
    YEAR_MODELS_QUEUE: https://sqs.${self:provider.region}.amazonaws.com/${self:provider.accountId}/yearmodels
    UPDATE_BUCKET_NAME: fipefacil-dev-attachmentsbucket-j36o9zne9er4
    UPDATE_BUCKET_REGION: us-east-1
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:PutItem
        - dynamodb:UpdateItem
      Resource:
        - arn:aws:dynamodb:${self:provider.region}:${self:provider.accountId}:table/prices
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
      Resource:
        - arn:aws:sqs:${self:provider.region}:${self:provider.accountId}:references
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
      Resource:
        - arn:aws:sqs:${self:provider.region}:${self:provider.accountId}:brands
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
      Resource:
        - arn:aws:sqs:${self:provider.region}:${self:provider.accountId}:models
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
      Resource:
        - arn:aws:sqs:${self:provider.region}:${self:provider.accountId}:yearmodels
    - Effect: "Allow"
      Action:
        - "s3:PutObject"
      Resource:
        - Fn::Join: ["", [Fn::GetAtt: [AttachmentsBucket, Arn], "/*"]]

functions:
  checkForUpdate:
    handler: src/lambda/updateHandler.checkForUpdateHandler
    events:
      - http:
          path: /checkForUpdate
          method: get
  startUpdateReference:
    handler: src/lambda/updateHandler.startUpdateReferenceHandler
    events:
      - sqs:
          arn: arn:aws:sqs:${self:provider.region}:${self:provider.accountId}:references
          batchSize: ${self:custom.functions.batchSize}
      - http:
          path: /startUpdateReference
          method: get
  startUpdateBrand:
    handler: src/lambda/updateHandler.startUpdateBrandHandler
    reservedConcurrency: ${self:custom.functions.reservedConcurrency}
    timeout: ${self:custom.functions.timeout}
    events:
      - sqs:
          arn: arn:aws:sqs:${self:provider.region}:${self:provider.accountId}:brands
          batchSize: ${self:custom.functions.batchSize}
      - http:
          path: /startUpdateBrand
          method: get
  startUpdateModel:
    handler: src/lambda/updateHandler.startUpdateModelHandler
    reservedConcurrency: ${self:custom.functions.reservedConcurrency}
    events:
      - sqs:
          arn: arn:aws:sqs:${self:provider.region}:${self:provider.accountId}:models
          batchSize: ${self:custom.functions.batchSize}
      - http:
          path: /startUpdateModel
          method: get
  startUpdateYearModel:
    handler: src/lambda/updateHandler.startUpdateYearModelHandler
    reservedConcurrency: ${self:custom.functions.reservedConcurrency}
    events:
      - sqs:
          arn: arn:aws:sqs:${self:provider.region}:${self:provider.accountId}:yearmodels
          batchSize: ${self:custom.functions.batchSize}
      - http:
          path: /startUpdateYearModel
          method: get
  queryCurrentReference:
    handler: src/lambda/queryHandler.queryCurrentReference
    events:
      - http:
          path: /currentReference
          method: get
          cors: true
  queryBrands:
    handler: src/lambda/queryHandler.queryBrands
    events:
      - http:
          path: /{vehicleType}/brands
          method: get
          cors: true
          request:
            parameters:
              paths:
                vehicleType: true
  queryModels:
    handler: src/lambda/queryHandler.queryModels
    events:
      - http:
          path: /brand/{brandId}/models
          method: get
          cors: true
          request:
            parameters:
              paths:
                brandId: true
  queryYearModels:
    handler: src/lambda/queryHandler.queryYearModels
    events:
      - http:
          path: /model/{modelId}/yearModels
          method: get
          cors: true
          request:
            parameters:
              paths:
                modelId: true
  queryUpdateApp:
    handler: src/lambda/queryHandler.queryUpdateApp
    timeout: 900

resources:
  - ${file(serverless/resources-dynamodb.yml)}
  - ${file(serverless/resources-sqs.yml)}
  - ${file(serverless/resources-s3.yml)}

package:
  individually: true
  exclude:
    - node_modules/aws-sdk/**

plugins:
  - serverless-plugin-typescript
  - serverless-domain-manager
